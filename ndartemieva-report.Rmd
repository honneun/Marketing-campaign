---
title: 'HW 2: успех маркетинговой кампании'
author: "Артемиева Наталья, ndartemieva"
output: 
  html_document:
    code_folding: hide
---

## Задача

Главной задачей данного анализа является **предсказание, насколько успешна будет маркетинговая кампания**. Однако в данном анализе такое предсказание будет основываться на определённых характеристиках потребителей. Иначе говоря, основываясь на данных о применении кампании в одном из магазинов, я попытаюсь определить конкретные группы потребителей, которые согласились на предложение. Также, задачей является выяснить есть ли статистически значимая зависимость между некоторыми характеристиками потребителей и согласием на предложение от магазина. Данные выводы будут сделаны с помощью различных статистических тестов, а результаты подкреплены выводами или визуальным представлением. Такой анализ необходим для того, чтобы определить, так называемую, **целевую аудиторию** маркетинговой кампании. В этом случае, целевой аудиторией будет та группа покупателей, которые наиболее вероятно согласятся на маркетинговое предложение.

### Загрузка данных и преобразование

```{r message = FALSE, warning=FALSE}
marketing = read.csv("~/shared/minor2_2022/1-Intro/hw2/marketing_campaign.csv")
library(dplyr)
library(rpart)
library(rpart.plot)
library(lubridate)
library(compareGroups)
library(ggplot2)
library(coin)
```

Для более удобной работы с данными я преобразовала переменную Dt_Customer, отображающую дату, когда респондент стал клиентом компании, в отдельные переменные, отображающие отдельно день, месяц и год. После преобразавания необходимо удалить изначальную переменную, чтобы наиболее конкретно определить, что влияет на согласие/отказ от предложения: день, год или месяц. После этого, я преобразую некоторые переменные в категориальные для более удобного анализа. Такими переменными стали Education, Marital_Status,Response, Complain и AcceptedCmp. 

```{r}
str(marketing)
marketing$Dt_Customer = dmy(marketing$Dt_Customer)
marketing = marketing %>% mutate(day = day(Dt_Customer),
                                 month = month(Dt_Customer),
                                 year = year(Dt_Customer))
marketing = marketing %>% select (- Dt_Customer)

marketing$Education = as.factor(marketing$Education)
marketing$Marital_Status = as.factor(marketing$Marital_Status)
marketing$Response = as.factor(marketing$Response)
marketing$Complain = as.factor(marketing$Complain)
marketing$AcceptedCmp = as.factor(marketing$AcceptedCmp) 
```

### Исследовательские вопросы и тесты

#### 1. Есть ли определённые демографические признаки, которые влияют на то, согласился ли покупатель на маркетинговое предложение? 
```{r}
#сначала использую функцию compareGroups выделяя все демографические признаки покупателя, чтобы увидеть описательную статистику для каждого признака
demogr = compareGroups(Response ~ Education + Marital_Status + Year_Birth, data = marketing)
demogrtable <- createTable(demogr)
print(demogrtable, which.table = "descr")

#по таблице я увидела, что семейное положение согласившихся и отказавшихся отличается в том смысле, что наибольший процент отказавшихся/согласившихся на предложение имеет разное семейное положение. Таким образом, необходимо проверить есть ли взаимосвязь между ответом на кампанию и семейным положением клиента. Для этого использую тест хи-квадрат, так как обе переменные категориальные. H0 - разницы между семейным положением для разных групп (согласившихся/отказавшихся) от маркетингового предложения нет. Н1- разница между семейным положением для разных групп (согласившихся/отказавшихся) от маркетингового предложения есть.
chisq.test(x = marketing$Response, y = marketing$Marital_Status)
#по тесту хи-квадрат мы не можем подтвердить нулевую гипотезу, так как p-value<0.05.

marketing = marketing %>% mutate(newcampaign = ifelse(Response == 1, "Согласился", "Отказался"))  

ggplot() +
  geom_bar(data = marketing, aes(x = Marital_Status),  col = "lightblue", fill = "lightblue")+
  ggtitle("Семейное положение покупателей\nсогласившихся/отказавшихся от предложения")+
  ylab ("Количество") +
  xlab("Семейное положение")+
  facet_grid(newcampaign ~.) +
  theme_minimal() 
```
По таблице можно увидеть, что на кампанию **чаще соглашаются одинокие люди по семейному положению**, в то время как **большая доля женатых людей отказывается от кампании**. Более того, зависимость между переменными семейное положение и согласие на актуальную маркетинговую кампанию статистически значима на уровне значимости 0.05

#### 2. Существует ли зависимость между согласием на предложением и годом, когда респондент стал клиентом компании?
```{r}
# по данным можно увидеть, что представленные годы, когда респондент стал клиентом компании, варьируются от 2012 до 2014. Исходя из этого, переменную year можно сделать категориальной для более удобного представления.
marketing$year = as.factor(marketing$year)

#Для использования статтеста я определила следующие гипотезы: Н0 - разницы в распределении годов, в который респондент стал клиентом, для групп согласившихся и отказавшихся нет. Н1 - разница в распределении годов, в который респондент стал клиентом, для групп согласившихся и отказавшихся есть. Чтобы проверить эти гипотезы, я буду использовать тест хи-квадрат, так как обе переменные категориальные.
chisq.test(x = marketing$Response, y = marketing$year)
# по результатам хи-квадарт статтеста мы не можем подтвердить нулевую гипотезу, так как p-value<0.05. Соответственно разница в распределении годов есть.
```
С помощью статеста было выявлено, что **есть некая зависимость между годом, в который клиент стал клиентом, и тем, согласился ли он на актуальное маркетинговое предложение.** Разница в распределении годов статистически значима на уровне значимости 0.05.

#### 3. Существует ли зависимость между доходом клиента и согласием на предложение? 
```{r}
#В этом исследовательском вопросе я определила следующие гипотезы: Н0 - доход людей, согласившихся на предложение, не отличается от дохода людей, отказавшихся от предложения.Н1 - доход людей, согласившихся на предложение, отличается от дохода людей, отказавшихся от предложения. Для проверки гипотез я использую тест перестановокб так как одна переменная категориальная а другая числовая.
independence_test(Response ~ Income, data = marketing)
#на уровне значимости 0.05 я не могу подтвердить нулевую гипотезу, так как p-value <0.05. Соответственно, разница в доходах есть.

marketing = marketing[-64,]
ggplot(data = marketing, aes(x = newcampaign, y = Income))+
  geom_boxplot(fill = c("#deebf7", "#9ecae1"), col = "#20559A")+
  ggtitle("Доход у согласившихся и отказавшихся клиентов")+
  xlab("Согласился ли клиент на предложение?")+
  ylab("Доход")+
  theme_minimal()
  
```
По результатам статистического теста можно сделать вывод, что **статистически значимая разница в доходах принявших или не принявших предложение есть**. Более того, по представленной визуализации можно увидеть что медиана доходов ниже у отказавшихся людей. 


### Предсказание отклика на кампанию

```{r}
#для того, чтобы выяснить точность предсказания необходимо разделить выборку на тренировочную и тестовую. Также необходимо удалить переменную, созданную для визуализации выводов (newcampaign)
marketing = marketing %>% select (-newcampaign)
set.seed(1234)
train = sample_frac(marketing, 0.8)
test = marketing %>% anti_join(train)

#строю дерево по всем переменным
tree = rpart(Response ~., data = train, method = "class")
prp(tree, extra = 2)
firstpred = predict(tree, test, type = "class")
table = table(firstpred, test$Response)
(table[1,1] + table[2,2])/sum(table)
#accuracy данного деревa = 0.801

#для более глубокого анализа, сделаю еще одно дерево по преполагаемым характеристикам
tree2 = rpart(Response ~ AcceptedCmp + Marital_Status + year + Income + MntMeatProducts + MntFishProducts + MntSweetProducts + MntWines + MntFruits + Year_Birth, data = train, method = "class")
prp(tree2, extra = 2)
secondpred = predict(tree2, test, type = "class")
t = table(secondpred, test$Response)
(t[1,1] + t[2,2])/sum(t)
#accuracy данного дерева = 0.79

#и еще одно дерево 
tree3 = rpart(Response ~ Income + MntMeatProducts + MntFishProducts + MntSweetProducts + MntWines + MntFruits + NumDealsPurchases + NumWebPurchases + NumStorePurchases, data = train, method = "class" )
prp(tree3, extra = 2)
thirdpred = predict(tree3, test, type = "class")
ta = table(thirdpred, test$Response)
(ta[1,1] + ta[2,2])/sum(ta)
#accuracy данного дерева = 0.805. так как это дерево с наибольшей точностью, вывод будет сделан по нему
```
*Вывод:* Для построения дерева были использованы такие переменные, как доход, сумма, потраченная на вино, мясо ирыбу за последние два года, количество покупок, совершенных в магазине и через сайт. Дерево обладает точностью **80,5%**.

Первой точкой разбиения в данном дереве стал доход. Наибольшее количество отклонивших предложение актуальной маркетинговой кампании находится в самом левом узле. Таких клиентов **584**, определяющими факторами является доход меньше 77 000, потраченная на вино сумма меньше 765, потраченная на мясо сумма меньше 451 и количество покупок, совешенных в магазине, больше или равно трем. Узел, в котором наибольшее количество людей принявших предложение состоит из **59** человек. Критериями для согласия на кампанию в этом узле являются: доход выше 82 000 и количество покупок через веб-сайт больше 3. 



## Общие выводы

Таким образом, из полученных результатов можно сделать вывод, что в качестве целевой аудитории данной маркетинговой кампании можно рассматривать одиноких людей с высоким доходом, часто совершающих покупки в мясном и винном отделе. Более того, необходимо обратить внимание на количество покупок совершенных в магазине или через веб-сайт. 